<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>KnowUrColors Dashboard</title>
  <meta name="description" content="KnowUrColors offers powerful online color tools including Color Matcher, Color Picker, Color Blindness Simulation, and a Complete Palette for detailed color information.">

  <!-- CSRF meta tag (added) -->
  <meta name="csrf-token" content="{{ csrf_token() }}">

  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Roboto&display=swap" rel="stylesheet">
  <style>
    /* -------------------------
       Base Styles
       ------------------------- */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    body {
      font-family: 'Roboto', sans-serif;
      background: #f7f7f7;
      padding: 20px;
      color: #333;
      text-align: center;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }
    h1 {
      font-family: 'Montserrat', sans-serif;
      margin-bottom: 20px;
      font-weight: 700;
    }
    
    .tabs {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    .tab-btn {
      background: #1976d2;
      color: #fff;
      padding: 10px 20px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: background 0.3s ease;
      font-size: 0.95rem;
    }
    .tab-btn:hover,
    .tab-btn.active {
      background: #1565c0;
    }
    
    .facility-section {
      display: none;
      background: #fff;
      border: 1px solid #e0e0e0;
      border-radius: 6px;
      padding: 20px;
      margin: 0 auto 20px auto;
      max-width: 1200px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
    }
    .facility-section.active {
      display: block;
    }
    
    /* Preview & Picker Styles */
    .preview-box {
      width: 30vw;
      height: 30vw;
      min-width: 200px;
      min-height: 200px;
      border: 1px solid #e0e0e0;
      border-radius: 4px;
      background: #fafafa;
      overflow: hidden;
      cursor: pointer;
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: transform 0.3s ease;
      margin: 0 auto;
    }
    .preview-box:hover {
      transform: translateY(-3px);
    }
    .preview-box img,
    .preview-box canvas {
      width: 100%;
      height: 100%;
      object-fit: contain;
      object-position: center;
      display: block;
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    .preview-box img.loaded,
    .preview-box canvas.loaded {
      opacity: 1;
    }
    .preview-box.empty {
      background: url("data:image/svg+xml,%3Csvg fill='%23ccc' xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Cline x1='32' y1='16' x2='32' y2='48' stroke='%23ccc' stroke-width='4'/%3E%3Cline x1='16' y1='32' x2='48' y2='32' stroke='%23ccc' stroke-width='4'/%3E%3C/svg%3E") center center no-repeat;
      background-size: 40px 40px;
    }
    
    .matcher-row, .picker-row, .cb-row {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 20px;
      margin-bottom: 20px;
    }
    .matcher-box, .picker-box, .cb-box {
      flex: 0 0 auto;
      text-align: center;
    }
    
    #pickerContainer {
      width: 30vw;
      height: 30vw;
      min-width: 200px;
      min-height: 200px;
      border: 1px solid #ddd;
      border-radius: 4px;
      background: #fafafa url("data:image/svg+xml,%3Csvg fill='%23ccc' xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Cline x1='32' y1='16' x2='32' y2='48' stroke='%23ccc' stroke-width='4'/%3E%3Cline x1='16' y1='32' x2='48' y2='32' stroke='%23ccc' stroke-width='4'/%3E%3C/svg%3E") center center no-repeat;
      background-size: 40px 40px;
      cursor: pointer;
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    #pickerCanvas {
      display: none;
      width: 100%;
      height: 100%;
      object-fit: contain;
      object-position: center;
    }
    #globalColorDisplay {
      text-align: center;
      font-weight: 500;
      margin-top: 10px;
      font-size: 1.1rem;
    }
    #paletteContainer {
      display: flex;
      flex-direction: column;
      gap: 10px;
      max-width: 30vw;
      min-width: 200px;
      margin: 0 auto;
      padding-bottom: 10px;
      overflow-y: auto;
      max-height: 400px;
    }
    .palette-row {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 5px;
      border: 1px solid #e0e0e0;
      border-radius: 4px;
      background: #fff;
    }
    .palette-swatch {
      width: 50px;
      height: 50px;
      border: 1px solid #e0e0e0;
      border-radius: 4px;
      background: #fff;
      flex-shrink: 0;
    }
    .palette-text {
      font-size: 14px;
      color: #333;
    }
    
    /* Complete Palette Facility Styles */
    .complete-palette-controls {
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      flex-wrap: wrap;
    }
    .complete-palette-search {
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }
    /* Updated grid: fixed 5 columns */
    .complete-palette-grid {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 10px;
      max-height: 400px;
      overflow-y: auto;
      padding: 10px;
    }
    .color-card {
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 4px;
      padding: 5px;
      text-align: center;
      cursor: pointer;
      transition: transform 0.3s ease;
    }
    .color-card:hover {
      transform: scale(1.05);
    }
    .color-swatch {
      width: 100%;
      padding-bottom: 100%; /* square */
      border-radius: 4px;
      margin-bottom: 5px;
      position: relative;
    }
    .color-swatch div {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      border-radius: 4px;
    }
    .color-hex {
      font-weight: bold;
      font-size: 0.85rem;
    }
    .search-result {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 20px;
      border: 1px solid #ddd;
      border-radius: 4px;
      padding: 10px;
      margin-top: 10px;
    }
    .search-result .swatch {
      width: 100px;
      height: 100px;
      border-radius: 4px;
    }
    .search-result .details {
      font-size: 1rem;
      text-align: left;
    }
    
    /* Modal for Color Details */
    #colorModal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: none;
      align-items: center;
      justify-content: center;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
    }
    #colorModalContent {
      background: #fff;
      padding: 20px;
      border-radius: 8px;
      text-align: center;
      transform: scale(0.8);
      transition: transform 0.3s ease;
      max-width: 300px;
      width: 90%;
      position: relative;
    }
    #colorModal.show #colorModalContent {
      transform: scale(1);
    }
    #modalClose {
      position: absolute;
      top: 5px;
      right: 10px;
      cursor: pointer;
      font-size: 18px;
      font-weight: bold;
    }
    
    /* Footer & About Section */
    footer {
      margin-top: auto;
      padding: 20px;
      background: #fff;
      border-top: 1px solid #e0e0e0;
      text-align: center;
      font-size: 0.85rem;
    }
    footer a {
      color: #1976d2;
      text-decoration: none;
      margin: 0 10px;
    }
    footer a:hover {
      text-decoration: underline;
    }
    .about-section {
      background: #fff;
      border: 1px solid #e0e0e0;
      border-radius: 6px;
      padding: 20px;
      max-width: 800px;
      margin: 20px auto;
      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
      text-align: left;
    }
    .about-section h2 {
      font-family: 'Montserrat', sans-serif;
      color: #1976d2;
      margin-bottom: 10px;
      font-style: italic;
    }
    .about-section p,
    .about-section ul {
      font-style: italic;
      color: #555;
      line-height: 1.6;
      margin-bottom: 10px;
    }
    .about-section ul {
      list-style-type: disc;
      margin-left: 20px;
    }
    .btn-download {
      background: #1976d2;
      color: #fff;
      padding: 10px 20px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: background 0.3s ease;
      font-size: 0.95rem;
      margin-top: 10px;
      display: none;
    }
    .btn-download:hover {
      background: #1565c0;
    }
    
    /* Hide file inputs completely */
    .hidden-input {
      display: none !important;
    }
  </style>
</head>
<body>
  <h1>KnowUrColors Dashboard</h1>
  
  <!-- Tab Navigation -->
  <div class="tabs">
    <button class="tab-btn active" onclick="showFacility('matcher')">Color Matcher</button>
    <button class="tab-btn" onclick="showFacility('picker')">Color Picker</button>
    <button class="tab-btn" onclick="showFacility('blindness')">Color Blindness</button>
    <button class="tab-btn" onclick="showFacility('completePalette')">Complete Palette</button>
  </div>
  
  <!-- 1) Color Matcher Section -->
  <div class="facility-section active" id="matcherSection">
    <div class="matcher-row">
      <div class="matcher-box">
        <div class="preview-box empty" id="refBox">
          <img id="samplePreview" class="preview-img" src="" alt="Reference Preview">
        </div>
      </div>
      <div class="matcher-box">
        <div class="preview-box empty" id="userBox">
          <img id="userPreview" class="preview-img" src="" alt="User/Result Preview">
        </div>
      </div>
    </div>
    <input type="file" id="sampleInput" class="hidden-input" accept="image/*">
    <input type="file" id="userInput" class="hidden-input" accept="image/*">
    <div class="btn-group">
      <button onclick="processImages()">Match Colors</button>
      <button onclick="resetMatcher()">Refresh</button>
    </div>
    <div id="loading" style="margin-top:10px; display:none;">Processing...</div>
    <div class="btn-group" style="margin-top:10px;">
      <a id="downloadLink" href="#" download="KnowUrColors_result.jpg" style="display:none;">
        <button>Download Result</button>
      </a>
    </div>
  </div>
  
  <!-- 2) Color Picker Section -->
  <div class="facility-section" id="pickerSection">
    <div class="picker-row">
      <div class="picker-box">
        <div id="pickerContainer" class="preview-box empty">
          <canvas id="pickerCanvas" style="display:none;"></canvas>
        </div>
        <input type="file" id="colorInput" class="hidden-input" accept="image/*">
        <div id="globalColorDisplay">Hover over image to see color</div>
      </div>
      <div class="picker-box">
        <div id="paletteContainer"></div>
        <div class="btn-group">
          <button id="downloadPaletteImageBtn" class="btn-download" onclick="downloadPaletteImage()">Download Palette Image</button>
          <button id="downloadPaletteTextBtn" class="btn-download" onclick="downloadPaletteText()">Download Palette Text</button>
          <button id="downloadPaletteChartBtn" class="btn-download" onclick="downloadPaletteChart()">Download Palette Chart</button>
        </div>
      </div>
    </div>
    <div class="btn-group">
      <button onclick="resetPicker()">Refresh</button>
    </div>
  </div>
  
  <!-- 3) Color Blindness Section -->
  <div class="facility-section" id="blindnessSection">
    <div class="cb-row">
      <div class="cb-box">
        <div class="preview-box empty" id="cbInputBox">
          <img id="cbInputPreview" class="preview-img" src="" alt="Original Preview">
        </div>
      </div>
      <div class="cb-box">
        <div class="preview-box empty" id="cbResultBox">
          <img id="cbResultPreview" class="preview-img" src="" alt="Simulated Preview">
        </div>
      </div>
    </div>
    <input type="file" id="cbInput" class="hidden-input" accept="image/*">
    <div style="margin-top:10px;">
      <select id="deficiencySelect">
        <option value="normal">Normal</option>
        <option value="protanopia">Protanopia</option>
        <option value="deuteranopia">Deuteranopia</option>
        <option value="tritanopia">Tritanopia</option>
      </select>
      <button onclick="simulateCB()">Simulate</button>
      <button onclick="resetBlindness()">Refresh</button>
    </div>
    <div class="btn-group" style="margin-top:10px;">
      <a id="cbDownloadLink" href="#" download="KnowUrColors_cb_result.jpg" style="display:none;">
        <button>Download Simulation</button>
      </a>
    </div>
  </div>
  
  <!-- 4) Complete Palette Section -->
  <div class="facility-section" id="completePaletteSection">
    <h2>Complete Color Palette</h2>
    <div class="complete-palette-controls">
      <label for="resolutionSlider">Color Resolution (per channel): <span id="resolutionValue">8</span></label>
      <input type="range" id="resolutionSlider" min="2" max="16" value="8" oninput="updateResolutionValue(this.value)">
    </div>
    <!-- New Search Functionality with Refresh Button -->
    <div class="complete-palette-search">
      <input type="text" id="colorSearchInput" placeholder="Enter hex code e.g. #FF5733">
      <button onclick="searchColor()">Search</button>
      <button onclick="refreshSearch()">Refresh</button>
    </div>
    <div id="searchResultContainer" style="display:none;"></div>
    <div class="complete-palette-grid" id="completePaletteGrid"></div>
  </div>
  
  <!-- About Section -->
  <div class="about-section">
    <h2>About KnowUrColors</h2>
    <p><em>KnowUrColors is an online suite of powerful color tools designed to help you transform images, generate comprehensive color palettes, and simulate various color vision deficiencies. Our intuitive tools include:</em></p>
    <ul>
      <li><strong>Color Matcher:</strong> <em>Transfer color styles seamlessly between images.</em></li>
      <li><strong>Color Picker:</strong> <em>Extract and view all unique colors from your images with corresponding hex codes.</em></li>
      <li><strong>Color Blindness Simulation:</strong> <em>Experience your images through different color vision perspectives.</em></li>
      <li><strong>Complete Palette:</strong> <em>Explore a full grid of colors – essentially every color that has a hex code – with slider control, search capability, and zoomable details.</em></li>
    </ul>
    <p><em>Discover your perfect color scheme with KnowUrColors today!</em></p>
  </div>
  
  <!-- Footer -->
  <footer>
    <a href="/privacy" target="_blank">Privacy Policy</a> |
    <a href="/terms" target="_blank">Terms of Service</a> |
    <a href="/about" target="_blank">About KnowUrColors</a> |
    <a href="/contact" target="_blank">Contact</a>
  </footer>
  
  <!-- Modal for Color Details -->
  <div id="colorModal" onclick="closeColorModal()">
    <div id="colorModalContent" onclick="event.stopPropagation()">
      <span id="modalClose" onclick="closeColorModal()">X</span>
      <div id="modalColorSwatch" style="width: 100px; height: 100px; margin: auto; border-radius: 4px;"></div>
      <div id="modalColorName" style="margin-top:10px; font-weight:bold;"></div>
      <div id="modalColorHex" style="margin-top:5px;"></div>
      <div id="modalColorRGB" style="margin-top:5px;"></div>
    </div>
  </div>
  
  <script>
    // -------------------------------
    // Minimal JS changes for CSRF
    // -------------------------------
    const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
    
    /********* GLOBAL VARIABLES *********/
    let pickerCtx, imgObj;
    let pickerOffCanvas, pickerOffCtx;
    let previewData = "";
    let imgOffsetX = 0, imgOffsetY = 0, imgDrawW = 0, imgDrawH = 0;
    
    /********* TAB NAVIGATION *********/
    const tabBtns = document.querySelectorAll('.tab-btn');
    const sections = {
      matcher: document.getElementById('matcherSection'),
      picker: document.getElementById('pickerSection'),
      blindness: document.getElementById('blindnessSection'),
      completePalette: document.getElementById('completePaletteSection')
    };
    function showFacility(facility) {
      tabBtns.forEach(btn => btn.classList.remove('active'));
      Object.values(sections).forEach(sec => sec.classList.remove('active'));
      if (facility === 'matcher') {
        sections.matcher.classList.add('active');
        tabBtns[0].classList.add('active');
      } else if (facility === 'picker') {
        sections.picker.classList.add('active');
        tabBtns[1].classList.add('active');
      } else if (facility === 'blindness') {
        sections.blindness.classList.add('active');
        tabBtns[2].classList.add('active');
      } else if (facility === 'completePalette') {
        sections.completePalette.classList.add('active');
        tabBtns[3].classList.add('active');
        generateCompletePalette();
      }
    }
    
    /********* FILE INPUT TRIGGERS *********/
    document.getElementById('refBox').addEventListener('click', function(){
      document.getElementById('sampleInput').click();
    });
    document.getElementById('userBox').addEventListener('click', function(){
      document.getElementById('userInput').click();
    });
    document.getElementById('pickerContainer').addEventListener('click', function(){
      document.getElementById('colorInput').click();
    });
    document.getElementById('cbInputBox').addEventListener('click', function(){
      document.getElementById('cbInput').click();
    });
    
    /********* IMAGE PREVIEW HELPER *********/
    function previewImage(file, imgId) {
      if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
          const img = document.getElementById(imgId);
          img.src = e.target.result;
          img.classList.remove('empty');
          img.classList.add('loaded');
          img.parentElement.classList.remove('empty');
        };
        reader.readAsDataURL(file);
      }
    }
    document.getElementById('sampleInput').addEventListener('change', function(){
      previewImage(this.files[0], 'samplePreview');
    });
    document.getElementById('userInput').addEventListener('change', function(){
      previewImage(this.files[0], 'userPreview');
    });
    document.getElementById('cbInput').addEventListener('change', function(){
      previewImage(this.files[0], 'cbInputPreview');
    });
    
    /********* 1) COLOR MATCHER PROCESS *********/
    function processImages() {
      const sampleInput = document.getElementById("sampleInput");
      const userInput = document.getElementById("userInput");
      if (!sampleInput.files[0] || !userInput.files[0]) {
        alert("Please add both images.");
        return;
      }
      const formData = new FormData();
      formData.append("sample", sampleInput.files[0]);
      formData.append("user", userInput.files[0]);
      document.getElementById("loading").style.display = "block";
      fetch("/process", {
        method: "POST",
        headers: { "X-CSRFToken": csrfToken },
        body: formData
      })
      .then(response => response.json())
      .then(data => {
        document.getElementById("loading").style.display = "none";
        if (data.error) {
          alert(data.error);
        } else {
          const userImg = document.getElementById("userPreview");
          userImg.src = data.result_img;
          userImg.classList.remove('empty');
          userImg.classList.add('loaded');
          document.getElementById("downloadLink").href = data.result_img;
          document.getElementById("downloadLink").style.display = "inline-block";
        }
      })
      .catch(err => {
        document.getElementById("loading").style.display = "none";
        console.error(err);
        alert("Error processing images.");
      });
    }
    function resetMatcher() {
      ['samplePreview', 'userPreview'].forEach(id => {
        const img = document.getElementById(id);
        img.src = "";
        img.classList.remove('loaded');
        img.parentElement.classList.add('empty');
      });
      document.getElementById("sampleInput").value = "";
      document.getElementById("userInput").value = "";
      document.getElementById("downloadLink").style.display = "none";
    }
    
    /********* 2) COLOR PICKER & PALETTE *********/
    const colorInput = document.getElementById("colorInput");
    const pickerCanvas = document.getElementById("pickerCanvas");
    const globalColorDisplay = document.getElementById("globalColorDisplay");
    const paletteContainer = document.getElementById("paletteContainer");
    let paletteHexCodes = [];
    
    colorInput.addEventListener("change", function(){
      const file = this.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(e) {
        imgObj = new Image();
        imgObj.onload = function() {
          const container = document.getElementById("pickerContainer");
          const containerW = container.clientWidth;
          const containerH = container.clientHeight;
          pickerCanvas.width  = containerW;
          pickerCanvas.height = containerH;
          pickerCanvas.style.display = "block";
          pickerCtx = pickerCanvas.getContext("2d");
          pickerCtx.fillStyle = "#fff";
          pickerCtx.fillRect(0, 0, containerW, containerH);
          
          let scale = Math.min(containerW / imgObj.naturalWidth, containerH / imgObj.naturalHeight);
          imgDrawW = imgObj.naturalWidth * scale;
          imgDrawH = imgObj.naturalHeight * scale;
          
          imgOffsetX = (containerW - imgDrawW) / 2;
          imgOffsetY = (containerH - imgDrawH) / 2;
          pickerCtx.drawImage(imgObj, 0, 0, imgObj.naturalWidth, imgObj.naturalHeight, imgOffsetX, imgOffsetY, imgDrawW, imgDrawH);
          pickerCanvas.classList.add("loaded");
          
          // Create an offscreen canvas from the actual image (scaled to fit)
          pickerOffCanvas = document.createElement("canvas");
          pickerOffCanvas.width = imgDrawW;
          pickerOffCanvas.height = imgDrawH;
          pickerOffCtx = pickerOffCanvas.getContext("2d");
          pickerOffCtx.drawImage(imgObj, 0, 0, imgObj.naturalWidth, imgObj.naturalHeight, 0, 0, imgDrawW, imgDrawH);
          
          // Generate palette using the offscreen canvas
          generatePalette();
        }
        imgObj.src = e.target.result;
        document.getElementById("pickerContainer").classList.remove('empty');
      }
      reader.readAsDataURL(file);
    });
    
    pickerCanvas.addEventListener("mousemove", function(e){
      if (!pickerCtx || !imgObj) return;
      const rect = pickerCanvas.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;
      const pixel = pickerCtx.getImageData(x, y, 1, 1).data;
      const hex = "#" + ((1 << 24) + (pixel[0]<<16) + (pixel[1]<<8) + pixel[2]).toString(16).slice(1);
      globalColorDisplay.textContent = "Color: " + hex;
    });
    
    pickerCanvas.addEventListener("mouseleave", function(){
      globalColorDisplay.textContent = "Hover over image to see color";
    });
    
    // Updated generatePalette function (unchanged from previous)
    function generatePalette() {
      paletteContainer.innerHTML = "";
      paletteHexCodes = [];
      if (!pickerOffCtx) return;
      const canvasWidth = pickerOffCanvas.width;
      const canvasHeight = pickerOffCanvas.height;
      const swatchSize = 50;
      let uniqueColors = new Set();
      
      // Iterate over the full image with adjustments for edge cells
      for (let y = 0; y < canvasHeight; y += swatchSize) {
        for (let x = 0; x < canvasWidth; x += swatchSize) {
          const cellWidth = Math.min(swatchSize, canvasWidth - x);
          const cellHeight = Math.min(swatchSize, canvasHeight - y);
          const data = pickerOffCtx.getImageData(x, y, cellWidth, cellHeight).data;
          let rSum = 0, gSum = 0, bSum = 0, count = 0;
          for (let i = 0; i < data.length; i += 4) {
            rSum += data[i];
            gSum += data[i+1];
            bSum += data[i+2];
            count++;
          }
          const avgR = Math.round(rSum / count);
          const avgG = Math.round(gSum / count);
          const avgB = Math.round(bSum / count);
          const hex = "#" + ((1 << 24) + (avgR<<16) + (avgG<<8) + avgB).toString(16).slice(1);
          
          if (!uniqueColors.has(hex)) {
            uniqueColors.add(hex);
            paletteHexCodes.push(hex);
            
            const rowDiv = document.createElement("div");
            rowDiv.className = "palette-row";
            const swatchDiv = document.createElement("div");
            swatchDiv.className = "palette-swatch";
            swatchDiv.style.backgroundColor = hex;
            const textDiv = document.createElement("div");
            textDiv.className = "palette-text";
            textDiv.textContent = hex;
            rowDiv.appendChild(swatchDiv);
            rowDiv.appendChild(textDiv);
            paletteContainer.appendChild(rowDiv);
          }
        }
      }
      if (paletteContainer.childElementCount > 0) {
        document.getElementById("downloadPaletteImageBtn").style.display = "inline-block";
        document.getElementById("downloadPaletteTextBtn").style.display = "inline-block";
        document.getElementById("downloadPaletteChartBtn").style.display = "inline-block";
      }
    }
    
    function resetPicker() {
      if (pickerCtx) pickerCtx.clearRect(0, 0, pickerCanvas.width, pickerCanvas.height);
      paletteContainer.innerHTML = "";
      paletteHexCodes = [];
      globalColorDisplay.textContent = "Hover over image to see color";
      document.getElementById("pickerContainer").classList.add("empty");
      document.getElementById("colorInput").value = "";
      document.getElementById("downloadPaletteImageBtn").style.display = "none";
      document.getElementById("downloadPaletteTextBtn").style.display = "none";
      document.getElementById("downloadPaletteChartBtn").style.display = "none";
    }
    
    function downloadPaletteImage() {
      if (paletteHexCodes.length === 0) {
        alert("Please generate a palette first.");
        return;
      }
      const swatchSize = 100;
      const cols = 4;
      const rows = Math.ceil(paletteHexCodes.length / cols);
      const canvasWidth = cols * swatchSize;
      const canvasHeight = rows * swatchSize;
      const canvas = document.createElement("canvas");
      canvas.width = canvasWidth;
      canvas.height = canvasHeight;
      const ctx = canvas.getContext("2d");
      for (let i = 0; i < paletteHexCodes.length; i++) {
        const row = Math.floor(i / cols);
        const col = i % cols;
        const x = col * swatchSize;
        const y = row * swatchSize;
        ctx.fillStyle = paletteHexCodes[i];
        ctx.fillRect(x, y, swatchSize, swatchSize);
        ctx.strokeStyle = "#e0e0e0";
        ctx.strokeRect(x, y, swatchSize, swatchSize);
      }
      const dataURL = canvas.toDataURL("image/png");
      const link = document.createElement("a");
      link.href = dataURL;
      link.download = "KnowUrColors_palette_image.png";
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }
    
    function downloadPaletteText() {
      if (paletteHexCodes.length === 0) {
        alert("Please generate a palette first.");
        return;
      }
      let textContent = "";
      paletteHexCodes.forEach(hex => {
        textContent += hex + "\n";
      });
      const blob = new Blob([textContent], { type: "text/plain" });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = "KnowUrColors_palette.txt";
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }
    
    function downloadPaletteChart() {
      if (paletteHexCodes.length === 0) {
        alert("Please generate a palette first.");
        return;
      }
      const elementsPerRow = 10;
      const cellWidth = 120;
      const cellHeight = 100;
      const padding = 20;
      const headerHeight = 40;
      const numRows = Math.ceil(paletteHexCodes.length / elementsPerRow);
      const canvasWidth = padding * 2 + elementsPerRow * cellWidth;
      const canvasHeight = padding * 2 + headerHeight + numRows * cellHeight;
      
      const canvas = document.createElement("canvas");
      canvas.width = canvasWidth;
      canvas.height = canvasHeight;
      const ctx = canvas.getContext("2d");
      
      ctx.fillStyle = "#fff";
      ctx.fillRect(0, 0, canvasWidth, canvasHeight);
      
      ctx.fillStyle = "#1976d2";
      ctx.font = "bold 20px Roboto";
      ctx.textAlign = "center";
      ctx.fillText("Palette Chart", canvasWidth / 2, padding + 25);
      
      ctx.font = "16px Roboto";
      ctx.textAlign = "center";
      paletteHexCodes.forEach((hex, index) => {
        const col = index % elementsPerRow;
        const row = Math.floor(index / elementsPerRow);
        const x = padding + col * cellWidth;
        const y = padding + headerHeight + row * cellHeight;
        const swatchSize = 50;
        const swatchX = x + (cellWidth - swatchSize) / 2;
        const swatchY = y + 10;
        ctx.fillStyle = hex;
        ctx.fillRect(swatchX, swatchY, swatchSize, swatchSize);
        ctx.strokeStyle = "#e0e0e0";
        ctx.strokeRect(swatchX, swatchY, swatchSize, swatchSize);
        ctx.fillStyle = "#000";
        ctx.fillText(hex, x + cellWidth / 2, swatchY + swatchSize + 20);
      });
      
      const dataURL = canvas.toDataURL("image/png");
      const link = document.createElement("a");
      link.href = dataURL;
      link.download = "KnowUrColors_palette_chart.png";
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }
    
    /********* 4) COMPLETE PALETTE FACILITY *********/
    // Generate the complete palette based on slider resolution
    function generateCompletePalette() {
      const resolution = parseInt(document.getElementById("resolutionSlider").value);
      const grid = document.getElementById("completePaletteGrid");
      grid.innerHTML = "";
      const frag = document.createDocumentFragment();
      // Calculate step size so that values are 0, step, 2*step, ... up to 255
      const step = resolution > 1 ? Math.round(255 / (resolution - 1)) : 255;
      for (let r = 0; r < resolution; r++) {
        for (let g = 0; g < resolution; g++) {
          for (let b = 0; b < resolution; b++) {
            const R = Math.round(r * step);
            const G = Math.round(g * step);
            const B = Math.round(b * step);
            const hex = "#" + ((1 << 24) + (R << 16) + (G << 8) + B).toString(16).slice(1).toUpperCase();
            const card = document.createElement("div");
            card.className = "color-card";
            card.innerHTML = `
              <div class="color-swatch"><div style="background-color: ${hex};"></div></div>
              <div class="color-hex">${hex}</div>
            `;
            card.addEventListener("click", () => showColorDetails({name: "Generated Color", hex: hex}));
            frag.appendChild(card);
          }
        }
      }
      grid.appendChild(frag);
    }
    
    function updateResolutionValue(val) {
      document.getElementById("resolutionValue").textContent = val;
      generateCompletePalette();
    }
    
    /********* SEARCH FUNCTIONALITY *********/
    function searchColor() {
      const input = document.getElementById("colorSearchInput").value.trim();
      const searchContainer = document.getElementById("searchResultContainer");
      // Regex to validate hex code (# optional followed by 6 hex digits)
      const hexRegex = /^(#)?([0-9A-Fa-f]{6})$/;
      if (!hexRegex.test(input)) {
        alert("Please enter a valid hex code (e.g. #FF5733).");
        return;
      }
      let hex = input;
      if (hex.charAt(0) !== "#") {
        hex = "#" + hex;
      }
      // Build search result in two-column layout
      searchContainer.innerHTML = `
        <div class="search-result">
          <div class="swatch" style="background-color: ${hex};"></div>
          <div class="details">
            <div>Hex: ${hex.toUpperCase()}</div>
            <div>RGB: ${hexToRGB(hex)}</div>
          </div>
        </div>
      `;
      searchContainer.style.display = "block";
    }
    
    function refreshSearch() {
      document.getElementById("colorSearchInput").value = "";
      document.getElementById("searchResultContainer").innerHTML = "";
      document.getElementById("searchResultContainer").style.display = "none";
    }
    
    /********* MODAL HANDLING *********/
    function showColorDetails(colorObj) {
      const modal = document.getElementById("colorModal");
      document.getElementById("modalColorSwatch").style.backgroundColor = colorObj.hex;
      document.getElementById("modalColorName").textContent = colorObj.name;
      document.getElementById("modalColorHex").textContent = "Hex: " + colorObj.hex;
      document.getElementById("modalColorRGB").textContent = "RGB: " + hexToRGB(colorObj.hex);
      modal.style.display = "flex";
      setTimeout(() => {
        modal.classList.add("show");
      }, 10);
    }
    
    function closeColorModal() {
      const modal = document.getElementById("colorModal");
      modal.classList.remove("show");
      setTimeout(() => {
        modal.style.display = "none";
      }, 300);
    }
    
    function hexToRGB(hex) {
      hex = hex.replace("#", "");
      if (hex.length === 3) {
        hex = hex.split("").map(c => c + c).join("");
      }
      const bigint = parseInt(hex, 16);
      const r = (bigint >> 16) & 255;
      const g = (bigint >> 8) & 255;
      const b = bigint & 255;
      return `${r}, ${g}, ${b}`;
    }
    
    /********* COLOR BLINDNESS SIMULATION *********/
    function simulateCB() {
      const cbInput = document.getElementById("cbInput");
      const deficiency = document.getElementById("deficiencySelect").value;
      if (!cbInput.files[0]) {
        alert("Please add an image.");
        return;
      }
      const formData = new FormData();
      formData.append("cbImage", cbInput.files[0]);
      formData.append("deficiency", deficiency);
      fetch("/simulate_cb", {
        method: "POST",
        headers: { "X-CSRFToken": csrfToken },
        body: formData
      })
      .then(response => response.json())
      .then(data => {
        if (data.error) {
          alert(data.error);
        } else {
          const resultEl = document.getElementById("cbResultPreview");
          resultEl.src = data.simulated_img;
          resultEl.classList.remove('empty');
          resultEl.classList.add('loaded');
          document.getElementById("cbDownloadLink").href = data.simulated_img;
          document.getElementById("cbDownloadLink").style.display = "inline-block";
        }
      })
      .catch(err => {
        console.error(err);
        alert("Error during simulation.");
      });
    }
    
    function resetBlindness() {
      ['cbInputPreview', 'cbResultPreview'].forEach(id => {
        const img = document.getElementById(id);
        img.src = "";
        img.classList.remove('loaded');
        img.parentElement.classList.add('empty');
      });
      document.getElementById("cbInput").value = "";
      document.getElementById("cbDownloadLink").style.display = "none";
    }
  </script>
</body>
</html>